{% extends "layout.html" %}
{% block content %}

<style>
  /* â”€â”€ Playground card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pg-card {
    background: #ffffff;
    border: 1px solid #e2ddd6;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  /* Header bar */
  .pg-header {
    background: #1a2535;
    padding: 1.1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.6rem;
  }
  .pg-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.15rem;
    color: #ffffff;
    margin: 0;
    letter-spacing: 0.01em;
  }
  .pg-subtitle {
    font-size: 0.78rem;
    color: #7a8799;
    margin: 0;
  }
  .ai-header-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: rgba(184,76,39,0.18);
    border: 1px solid rgba(184,76,39,0.35);
    color: #e8967a;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.2em 0.6em;
  }

  /* Round + score bar */
  .pg-meta {
    display: none;
    background: #f7f5f0;
    border-bottom: 1px solid #e2ddd6;
    padding: 0.65rem 1.5rem;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .pg-meta.visible { display: flex; }

  .round-badge {
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #b84c27;
    background: #f0ebe5;
    border: 1px solid rgba(184,76,39,.2);
    border-radius: 4px;
    padding: 0.25em 0.7em;
  }
  .score-strip { display: flex; gap: 1.2rem; }
  .score-pill {
    font-size: 0.82rem;
    font-weight: 600;
    color: #1a2535;
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }
  .score-pill .pts {
    background: #1a2535;
    color: #fff;
    border-radius: 999px;
    padding: 0.1em 0.55em;
    font-size: 0.75rem;
    font-weight: 700;
    min-width: 22px;
    text-align: center;
  }
  .score-pill.me .pts { background: #b84c27; }

  /* Progress bar */
  .pg-progress-wrap { height: 3px; background: #e2ddd6; display: none; }
  .pg-progress-wrap.visible { display: block; }
  .pg-progress-bar {
    height: 100%;
    background: #b84c27;
    width: 0%;
    transition: width 0.4s ease;
  }

  /* Body */
  .pg-body { padding: 1.5rem; }

  /* Status */
  .pg-status {
    font-size: 0.875rem;
    color: #6b6860;
    margin-bottom: 0;
    min-height: 1.4em;
  }
  .pg-status.waiting::before {
    content: '';
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #e6952a;
    margin-right: 6px;
    animation: pulse-dot 1.2s ease-in-out infinite;
    vertical-align: middle;
  }
  .pg-status.active::before {
    content: '';
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #27a35a;
    margin-right: 6px;
    vertical-align: middle;
  }
  .pg-status.error::before {
    content: '';
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #c0392b;
    margin-right: 6px;
    vertical-align: middle;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; transform: scale(1); }
    50%       { opacity: 0.4; transform: scale(0.7); }
  }

  /* AI generating loader */
  .pg-generating {
    display: none;
    align-items: center;
    gap: 0.75rem;
    background: #f7f5f0;
    border: 1px solid #e2ddd6;
    border-radius: 7px;
    padding: 0.9rem 1.1rem;
    margin-top: 1rem;
    font-size: 0.875rem;
    color: #6b6860;
    font-weight: 500;
  }
  .pg-generating.visible { display: flex; }
  .spinner {
    width: 18px; height: 18px;
    border: 2.5px solid #e2ddd6;
    border-top-color: #b84c27;
    border-radius: 50%;
    animation: spin 0.75s linear infinite;
    flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Common topics banner */
  .pg-topics {
    display: none;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.75rem;
    padding: 0.7rem 0.9rem;
    background: #eaf6ee;
    border: 1px solid #a7e3be;
    border-radius: 7px;
    align-items: center;
  }
  .pg-topics.visible { display: flex; }
  .pg-topics-label {
    font-size: 0.72rem;
    font-weight: 700;
    color: #1a5c37;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    margin-right: 0.3rem;
    flex-shrink: 0;
  }
  .topic-chip {
    font-size: 0.74rem;
    font-weight: 600;
    color: #1a5c37;
    background: #fff;
    border: 1px solid #a7e3be;
    border-radius: 999px;
    padding: 0.2em 0.65em;
  }

  /* Your modules list */
  .pg-modules-list {
    margin-top: 0.75rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }
  .module-chip {
    font-size: 0.72rem;
    font-weight: 600;
    color: #1a2535;
    background: #f0ebe5;
    border: 1px solid #d6cfc6;
    border-radius: 999px;
    padding: 0.2em 0.7em;
  }

  /* Join button */
  .btn-join {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: #1a2535;
    color: #ffffff;
    border: none;
    border-radius: 5px;
    padding: 0.45rem 1.1rem;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 180ms ease, transform 180ms ease;
    margin-top: 0.75rem;
  }
  .btn-join:hover:not(:disabled) { background: #243347; transform: translateY(-1px); }
  .btn-join:disabled { opacity: 0.45; cursor: not-allowed; }

  /* Question area */
  .pg-question-area { display: none; margin-top: 1.25rem; }
  .pg-question-area.visible { display: block; }

  /* AI question badge */
  .ai-question-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #b84c27;
    background: #f0ebe5;
    border: 1px solid rgba(184,76,39,.2);
    border-radius: 4px;
    padding: 0.2em 0.55em;
    margin-bottom: 0.65rem;
  }

  .question-text {
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
    color: #1c1c1e;
    line-height: 1.45;
    margin-bottom: 1.1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e2ddd6;
  }

  /* MCQ grid */
  .options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.65rem;
  }
  @media (max-width: 480px) { .options-grid { grid-template-columns: 1fr; } }

  .option-btn {
    display: flex;
    align-items: flex-start;
    gap: 0.7rem;
    background: #f7f5f0;
    border: 1.5px solid #e2ddd6;
    border-radius: 7px;
    padding: 0.75rem 0.9rem;
    cursor: pointer;
    text-align: left;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    color: #1c1c1e;
    line-height: 1.45;
    transition: border-color 150ms ease, background 150ms ease, transform 150ms ease;
    width: 100%;
  }
  .option-btn:hover:not(:disabled) {
    border-color: #1a2535;
    background: #ffffff;
    transform: translateY(-1px);
  }
  .option-btn:disabled { cursor: not-allowed; opacity: 0.6; }

  .option-label {
    flex-shrink: 0;
    width: 24px; height: 24px;
    border-radius: 50%;
    background: #1a2535;
    color: #ffffff;
    font-size: 0.72rem;
    font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    letter-spacing: 0.02em;
    margin-top: 1px;
  }

  .option-btn.correct  { border-color: #27a35a; background: #edf8f2; }
  .option-btn.correct .option-label { background: #27a35a; }
  .option-btn.wrong    { border-color: #c0392b; background: #fdf0ef; }
  .option-btn.wrong .option-label { background: #c0392b; }

  /* Feedback */
  .pg-feedback {
    margin-top: 0.9rem;
    font-size: 0.84rem;
    min-height: 1.3em;
    color: #6b6860;
    font-weight: 500;
  }
  .pg-feedback.success { color: #27a35a; }
  .pg-feedback.error   { color: #c0392b; }
  .pg-feedback.info    { color: #2980b9; }
  .pg-feedback.locked  { color: #9a8f85; font-style: italic; }

  /* Round countdown timer */
  .pg-timer {
    display: none;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    font-size: 0.8rem;
    color: #6b6860;
  }
  .pg-timer.visible { display: flex; }
  .timer-bar-wrap {
    flex: 1;
    height: 4px;
    background: #e2ddd6;
    border-radius: 2px;
    overflow: hidden;
  }
  .timer-bar {
    height: 100%;
    background: #27a35a;
    width: 100%;
    transition: width 1s linear, background 0.3s;
  }
  .timer-bar.warning  { background: #e6952a; }
  .timer-bar.danger   { background: #c0392b; }
  .timer-label {
    flex-shrink: 0;
    font-weight: 700;
    font-size: 0.78rem;
    min-width: 28px;
    text-align: right;
    color: #1a2535;
  }

  /* Match result */
  .pg-result { display: none; margin-top: 1.25rem; background: #f7f5f0; border: 1px solid #e2ddd6; border-radius: 8px; padding: 1.25rem 1.5rem; }
  .pg-result.visible { display: block; }
  .result-headline { font-family: 'DM Serif Display', serif; font-size: 1.25rem; color: #1c1c1e; margin-bottom: 0.5rem; }
  .result-scores { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.75rem; }
  .result-score-item { background: #fff; border: 1px solid #e2ddd6; border-radius: 6px; padding: 0.5rem 0.9rem; font-size: 0.875rem; font-weight: 600; color: #1a2535; }
  .result-score-item span { font-size: 1.1rem; color: #b84c27; margin-left: 0.3rem; }

  /* Locked / no-modules state */
  .pg-locked {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 2.5rem 1.5rem; text-align: center; gap: .75rem;
  }
  .pg-locked-icon { font-size: 2.2rem; line-height: 1; }
  .pg-locked-title { font-family: 'DM Serif Display', serif; font-size: 1.1rem; color: #1a2535; margin: 0; }
  .pg-locked-sub { font-size: .83rem; color: #6b7280; margin: 0; max-width: 320px; }
  .pg-locked-cta {
    display: inline-flex; align-items: center; gap: .4rem;
    background: #1a2535; color: #fff; border: none;
    border-radius: 6px; padding: .45rem 1.1rem;
    font-size: .84rem; font-weight: 600; cursor: pointer;
    text-decoration: none; margin-top: .25rem;
    transition: background .15s;
  }
  .pg-locked-cta:hover { background: #2e3f58; color: #fff; text-decoration: none; }

  /* Error banner */
  .pg-error-banner {
    display: none;
    margin-top: 1rem;
    padding: 0.8rem 1rem;
    background: #fdf0ef;
    border: 1px solid #f5c6c2;
    border-radius: 7px;
    font-size: 0.84rem;
    color: #c0392b;
    font-weight: 500;
  }
  .pg-error-banner.visible { display: block; }
</style>

<h1 style="font-family:'DM Serif Display',serif; font-size:1.9rem; margin-bottom:1.25rem;">Playground</h1>

<div class="pg-card">

  <!-- Header -->
  <div class="pg-header">
    <div>
      <p class="pg-title">ML Quiz â€” 1v1 Battle</p>
      <p class="pg-subtitle">10 rounds Â· AI-generated questions Â· One attempt Â· 30s timer</p>
    </div>
    <span class="ai-header-badge">
      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
      AI Questions
    </span>
  </div>

  <!-- Round / score bar -->
  <div id="pg-meta" class="pg-meta">
    <span id="round-badge" class="round-badge">Round 1 / 10</span>
    <div class="score-strip" id="score-strip"></div>
  </div>

  <!-- Progress bar -->
  <div id="pg-progress-wrap" class="pg-progress-wrap">
    <div id="pg-progress-bar" class="pg-progress-bar"></div>
  </div>

  <!-- Body -->
  <div class="pg-body">

    <p id="pg-status" class="pg-status">Idle.</p>

    {% if not current_user.is_authenticated %}
      <div class="pg-locked">
        <div class="pg-locked-icon">ðŸ”’</div>
        <p class="pg-locked-title">Login required</p>
        <p class="pg-locked-sub">You need to be logged in to enter the Playground.</p>
        <a href="{{ url_for('users.login') }}" class="pg-locked-cta">Login to play</a>
      </div>

    {% elif completed_count == 0 %}
      <div class="pg-locked">
        <div class="pg-locked-icon">ðŸ“š</div>
        <p class="pg-locked-title">Complete at least one module first</p>
        <p class="pg-locked-sub">
          The Playground generates questions based on modules you've studied.
          Finish at least one module in the Learn section before jumping in.
        </p>
        <a href="{{ url_for('learn.dashboard') }}" class="pg-locked-cta">Go to Learn â†’</a>
      </div>

    {% else %}
      <!-- Modules the user has completed -->
      <p style="font-size:0.78rem; font-weight:700; color:#6b6860; letter-spacing:0.06em; text-transform:uppercase; margin-bottom:0.35rem; margin-top:0.1rem;">
        Your completed modules (used for matchmaking)
      </p>
      <div class="pg-modules-list">
        {% for m in completed_modules %}
          <span class="module-chip">{{ m.title }}</span>
        {% endfor %}
      </div>

      <button id="btn-join" class="btn-join">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Find Opponent
      </button>
    {% endif %}

    <!-- Error banner -->
    <div id="pg-error-banner" class="pg-error-banner"></div>

    <!-- AI generating loader -->
    <div id="pg-generating" class="pg-generating">
      <div class="spinner"></div>
      <span>Generating AI questions from your shared topics â€” this takes a few secondsâ€¦</span>
    </div>

    <!-- Common topics banner (shown once match is found) -->
    <div id="pg-topics" class="pg-topics">
      <span class="pg-topics-label">ðŸ§  Topics</span>
      <span id="pg-topics-chips"></span>
    </div>

    <!-- Question + options -->
    <div id="pg-question-area" class="pg-question-area">
      <div id="ai-question-badge" class="ai-question-badge" style="display:none;">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        AI Generated
      </div>
      <p id="question-text" class="question-text"></p>
      <div id="options-grid" class="options-grid"></div>
      <div id="pg-timer" class="pg-timer">
        <div class="timer-bar-wrap"><div id="timer-bar" class="timer-bar"></div></div>
        <span id="timer-label" class="timer-label">30s</span>
      </div>
      <div id="pg-feedback" class="pg-feedback"></div>
    </div>

    <!-- End-of-match result -->
    <div id="pg-result" class="pg-result">
      <p id="result-headline" class="result-headline"></p>
      <p id="result-sub" style="font-size:0.875rem; color:#6b6860; margin:0;"></p>
      <div id="result-scores" class="result-scores"></div>
    </div>

  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
(function () {
  const btnJoin        = document.getElementById('btn-join');
  const pgStatus       = document.getElementById('pg-status');
  const pgMeta         = document.getElementById('pg-meta');
  const roundBadge     = document.getElementById('round-badge');
  const scoreStrip     = document.getElementById('score-strip');
  const progressWrap   = document.getElementById('pg-progress-wrap');
  const progressBar    = document.getElementById('pg-progress-bar');
  const pgGenerating   = document.getElementById('pg-generating');
  const pgTopics       = document.getElementById('pg-topics');
  const pgTopicsChips  = document.getElementById('pg-topics-chips');
  const questionArea   = document.getElementById('pg-question-area');
  const aiBadge        = document.getElementById('ai-question-badge');
  const questionText   = document.getElementById('question-text');
  const optionsGrid    = document.getElementById('options-grid');
  const pgFeedback     = document.getElementById('pg-feedback');
  const pgTimer        = document.getElementById('pg-timer');
  const timerBar       = document.getElementById('timer-bar');
  const timerLabel     = document.getElementById('timer-label');
  const pgResult       = document.getElementById('pg-result');
  const resultHeadline = document.getElementById('result-headline');
  const resultSub      = document.getElementById('result-sub');
  const resultScores   = document.getElementById('result-scores');
  const pgErrorBanner  = document.getElementById('pg-error-banner');

  if (!btnJoin) return;

  const socket = io();
  const MY_USERNAME = '{{ current_user.username if current_user.is_authenticated else "" }}';

  let inMatch       = false;
  let players       = [];
  let myUsername    = '';
  let totalRounds   = 10;
  let roundTimeout  = 30;
  let locked        = false;
  let usedAttempt   = false;
  let timerInterval = null;
  let myChosenLabel = null;

  /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const setStatus = (msg, cls = '') => {
    pgStatus.textContent = msg;
    pgStatus.className = 'pg-status' + (cls ? ' ' + cls : '');
  };

  const setFeedback = (msg, cls = '') => {
    pgFeedback.textContent = msg;
    pgFeedback.className = 'pg-feedback' + (cls ? ' ' + cls : '');
  };

  const showError = (msg) => {
    pgErrorBanner.textContent = msg;
    pgErrorBanner.classList.add('visible');
  };

  const hideError = () => {
    pgErrorBanner.classList.remove('visible');
    pgErrorBanner.textContent = '';
  };

  const updateMeta = (round, scores) => {
    roundBadge.textContent = `Round ${round} / ${totalRounds}`;
    progressBar.style.width = `${((round - 1) / totalRounds) * 100}%`;
    scoreStrip.innerHTML = players.map(u => {
      const isMe = u === myUsername;
      return `<div class="score-pill ${isMe ? 'me' : ''}">
        ${u} <span class="pts">${scores[u] ?? 0}</span>
      </div>`;
    }).join('');
  };

  const showTopics = (topics) => {
    if (!topics || !topics.length) return;
    pgTopicsChips.innerHTML = topics
      .map(t => `<span class="topic-chip">${t}</span>`)
      .join('');
    pgTopics.classList.add('visible');
  };

  /* â”€â”€ Countdown timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const startTimer = (seconds) => {
    stopTimer();
    let remaining = seconds;
    pgTimer.classList.add('visible');
    timerBar.style.transition = 'none';
    timerBar.style.width = '100%';
    timerBar.className = 'timer-bar';
    timerLabel.textContent = `${remaining}s`;
    timerBar.offsetHeight; // force reflow
    timerBar.style.transition = `width ${seconds}s linear`;
    timerBar.style.width = '0%';

    timerInterval = setInterval(() => {
      remaining -= 1;
      timerLabel.textContent = `${remaining}s`;
      if (remaining <= 10) timerBar.classList.add('warning');
      if (remaining <= 5)  timerBar.classList.add('danger');
      if (remaining <= 0)  stopTimer();
    }, 1000);
  };

  const stopTimer = () => {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    pgTimer.classList.remove('visible');
    timerBar.style.transition = 'none';
    timerBar.style.width = '100%';
    timerBar.className = 'timer-bar';
  };

  /* â”€â”€ Options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const buildOptions = (options) => {
    optionsGrid.innerHTML = '';
    usedAttempt = false;
    locked      = false;

    options.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.dataset.label = opt.label;
      btn.innerHTML = `<span class="option-label">${opt.label}</span><span>${opt.text}</span>`;
      btn.addEventListener('click', () => {
        if (locked || usedAttempt || !inMatch) return;
        usedAttempt = true;
        lockOptionsForPlayer();
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        myChosenLabel = opt.label;
        socket.emit('submit_answer', { label: opt.label });
      });
      optionsGrid.appendChild(btn);
    });
  };

  const lockOptionsForPlayer = () => {
    document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
  };

  const lockOptions = () => {
    locked = true;
    document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
  };

  const highlightResult = (correctLabel, chosenLabel) => {
    document.querySelectorAll('.option-btn').forEach(btn => {
      btn.classList.remove('selected');
      if (btn.dataset.label === correctLabel) {
        btn.classList.add('correct');
      } else if (chosenLabel && btn.dataset.label === chosenLabel) {
        btn.classList.add('wrong');
      }
    });
  };

  const showResult = (headline, sub, scores) => {
    pgResult.classList.add('visible');
    resultHeadline.textContent = headline;
    resultSub.textContent = sub;
    resultScores.innerHTML = Object.entries(scores)
      .map(([u, s]) => `<div class="result-score-item">${u}<span>${s}</span></div>`)
      .join('');
  };

  const resetUI = () => {
    inMatch = false; locked = false; usedAttempt = false; myChosenLabel = null;
    players = []; myUsername = '';
    stopTimer();
    hideError();
    pgMeta.classList.remove('visible');
    progressWrap.classList.remove('visible');
    questionArea.classList.remove('visible');
    pgResult.classList.remove('visible');
    pgGenerating.classList.remove('visible');
    pgTopics.classList.remove('visible');
    pgTopicsChips.innerHTML = '';
    optionsGrid.innerHTML = '';
    if (aiBadge) aiBadge.style.display = 'none';
    setFeedback('');
    progressBar.style.width = '0%';
  };

  /* â”€â”€ Join â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  btnJoin.addEventListener('click', () => {
    resetUI();
    setStatus('Searching for an opponent with matching modulesâ€¦', 'waiting');
    btnJoin.disabled = true;
    socket.emit('join_playground');
  });

  /* â”€â”€ Socket events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  socket.on('queue_status', ({ message, timed_out }) => {
    if (timed_out) {
      // Queue timed out â€” no match found
      btnJoin.disabled = false;
      setStatus('No match found.', 'error');
      showError(message);
      return;
    }
    if (message && message.includes('Generating questions with AI')) {
      setStatus('Opponent found! Generating questionsâ€¦', 'waiting');
      pgGenerating.classList.add('visible');
    } else {
      setStatus(message || 'Waitingâ€¦', 'waiting');
    }
  });

  socket.on('match_found', (payload) => {
    inMatch = true; locked = false; usedAttempt = false; myChosenLabel = null;
    players      = payload.players;
    myUsername   = MY_USERNAME;
    totalRounds  = payload.total_rounds;
    roundTimeout = payload.timeout || 30;

    pgGenerating.classList.remove('visible');
    hideError();
    pgMeta.classList.add('visible');
    progressWrap.classList.add('visible');
    pgResult.classList.remove('visible');
    btnJoin.disabled = true;

    // Show common topics banner
    showTopics(payload.common_topics);

    updateMeta(payload.round, payload.scores);
    questionText.textContent = payload.question;
    buildOptions(payload.options);
    questionArea.classList.add('visible');
    if (aiBadge) aiBadge.style.display = 'inline-flex';
    startTimer(roundTimeout);

    setStatus(`${players[0]} vs ${players[1]} â€” Round 1`, 'active');
    setFeedback('');
  });

  socket.on('match_error', ({ message }) => {
    // AI generation failed
    resetUI();
    btnJoin.disabled = false;
    setStatus('Match setup failed.', 'error');
    showError(message || 'Something went wrong generating questions. Please try again.');
  });

  socket.on('answer_result', (payload) => {
    if (payload.correct) {
      setFeedback('âœ“ Correct!', 'success');
    } else if (payload.locked) {
      setFeedback(payload.message || 'Wrong. Waiting for your opponentâ€¦', 'locked');
    }
  });

  socket.on('round_ended', (payload) => {
    stopTimer();
    locked = true;
    lockOptions();
    highlightResult(payload.correct_label, myChosenLabel);
    updateMeta(payload.round, payload.scores);
    myChosenLabel = null;

    if (payload.round_winner) {
      setFeedback(
        `${payload.message} (${payload.correct_label}: ${payload.correct_answer})`,
        'success'
      );
      setStatus(`Round ${payload.round} won by ${payload.round_winner}`, 'active');
    } else {
      setFeedback(
        `${payload.message} â€” Answer: ${payload.correct_label}: ${payload.correct_answer}`,
        'error'
      );
      setStatus(`Round ${payload.round} â€” No winner`, 'active');
    }
  });

  socket.on('next_round', (payload) => {
    locked = false; usedAttempt = false; myChosenLabel = null;
    roundTimeout = payload.timeout || 30;
    updateMeta(payload.round, payload.scores);
    questionText.textContent = payload.question;
    buildOptions(payload.options);
    setFeedback('');
    setStatus(`Round ${payload.round} of ${payload.total_rounds}`, 'active');
    startTimer(roundTimeout);
  });

  socket.on('match_ended', (payload) => {
    stopTimer();
    inMatch = false;
    btnJoin.disabled = false;

    let headline, sub;
    if (payload.reason === 'opponent_disconnected') {
      headline = `${payload.winner} wins â€” opponent disconnected`;
      sub = `+${payload.disconnect_bonus} bonus points awarded.`;
    } else if (payload.draw) {
      headline = "It's a draw!";
      sub = 'Points awarded for rounds won.';
    } else {
      headline = `${payload.winner} wins the match!`;
      sub = 'Points have been added to your account.';
    }

    questionArea.classList.remove('visible');
    pgMeta.classList.remove('visible');
    progressWrap.classList.remove('visible');
    setStatus('Match over. Find a new opponent to play again.', '');
    showResult(headline, sub, payload.scores);
  });

})();
</script>

{% endblock content %}
