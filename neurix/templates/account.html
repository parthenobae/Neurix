{% extends "layout.html" %}

{# Full-width â€” no sidebar #}
{% block content_col_class %}col-12{% endblock %}
{% block sidebar %}{% endblock %}

{% block content %}
<style>
/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; }

.acct-grid {
  display: grid;
  grid-template-columns: 200px 1fr;
  gap: 1.2rem;
  align-items: start;
}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-sidebar {
  background: #fff;
  border: 1.5px solid #e5e0d8;
  border-radius: 14px;
  padding: 1.4rem 1.1rem;
  text-align: center;
  box-shadow: 0 2px 8px rgba(26,37,53,.06);
  position: sticky;
  top: 80px;
}
.avatar-wrap { position: relative; display: inline-block; margin-bottom: .8rem; }
.avatar-img  { width: 84px; height: 84px; border-radius: 50%; border: 3px solid #e5e0d8; object-fit: cover; }
.online-dot  { position: absolute; bottom: 3px; right: 3px; width: 16px; height: 16px; background: #27a35a; border-radius: 50%; border: 2.5px solid #fff; }

.profile-name  { font-family: 'DM Serif Display', serif; font-size: 1.08rem; color: #1a2535; margin-bottom: .1rem; }
.profile-email { font-size: .72rem; color: #9a8f85; margin-bottom: .9rem; }

.pts-box  { background: #1a2535; border-radius: 10px; padding: .5rem .8rem; margin-bottom: .9rem; }
.pts-val  { font-family: 'DM Serif Display', serif; font-size: 1.65rem; color: #f59e0b; line-height: 1; }
.pts-lbl  { font-size: .65rem; color: #64748b; margin-top: 2px; }

.sdiv { border: none; border-top: 1px solid #f0ede8; margin: .8rem 0; }

.s-row { display: flex; justify-content: space-between; align-items: center; padding: .2rem 0; font-size: .76rem; }
.s-row .sk { color: #6b7280; }
.s-row .sv { font-weight: 700; color: #1a2535; }
.s-row .sv.accent { color: #b84c27; }
.s-row .sv.green  { color: #27a35a; }

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.acct-main { display: flex; flex-direction: column; gap: 1.1rem; }

.ac {
  background: #fff;
  border: 1.5px solid #e5e0d8;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(26,37,53,.05);
}
.ac-hd {
  display: flex; align-items: baseline; gap: .5rem;
  padding: .75rem 1.2rem;
  border-bottom: 1px solid #f0ede8;
}
.ac-hd-title { font-family: 'DM Serif Display', serif; font-size: .97rem; color: #1a2535; }
.ac-hd-sub   { font-size: .71rem; color: #9a8f85; }
.ac-bd { padding: 1rem 1.2rem; }

/* â”€â”€ Streak pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.streak-pills {
  display: grid; grid-template-columns: repeat(4,1fr); gap: .55rem;
  margin-bottom: 1.1rem;
}
.sp { background: #f7f5f0; border-radius: 10px; padding: .6rem .4rem; text-align: center; }
.sp-val { font-family: 'DM Serif Display', serif; font-size: 1.45rem; color: #1a2535; line-height: 1; display: block; }
.sp-val.fire  { color: #b84c27; }
.sp-val.green { color: #27a35a; }
.sp-lbl { font-size: .62rem; color: #9a8f85; margin-top: 3px; display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEETCODE HEATMAP  (pixel-perfect rebuild)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Stats bar above grid */
.hm-statsbar {
  display: flex; align-items: center; gap: 1.5rem;
  margin-bottom: .9rem; flex-wrap: wrap;
}
.hm-total-label { font-size: .85rem; color: #1a2535; }
.hm-total-label strong { font-weight: 700; }
.hm-stat { font-size: .78rem; color: #6b7280; }
.hm-stat span { font-weight: 600; color: #1a2535; }

/* Outer scroll wrapper */
.hm-outer { overflow-x: auto; padding-bottom: 6px; }

/* SVG-based grid â€” JS writes directly into an <svg> element */
.hm-svg {
  display: block;
  /* width/height set by JS */
}

/* Month labels sit BELOW the grid, just like LeetCode */
.hm-month-row {
  display: flex;
  /* padding-left matched to day-label offset in JS */
}
.hm-month-cell {
  font-size: .67rem;
  color: #6b7280;
  white-space: nowrap;
  display: inline-block;
  text-align: left;
}

/* Day-of-week labels */
.hm-day-labels {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  float: left;
  margin-right: 4px;
  height: 7*11px; /* set by JS */
}
.hm-day-label {
  font-size: .58rem;
  color: #9a8f85;
  line-height: 11px;
  height: 11px;
  text-align: right;
  white-space: nowrap;
}

/* Legend */
.hm-legend {
  display: flex; align-items: center; gap: 4px;
  margin-top: 6px; justify-content: flex-end;
  font-size: .64rem; color: #9a8f85;
}
.hm-leg { width: 11px; height: 11px; border-radius: 2px; }

/* Tooltip */
.hm-tip {
  position: fixed;
  background: #1a2535; color: #e2e8f0;
  font-size: .71rem; padding: .3rem .6rem;
  border-radius: 6px; pointer-events: none;
  display: none; z-index: 9999;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0,0,0,.3);
}

/* â”€â”€ Activity breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.act-grid {
  display: grid; grid-template-columns: repeat(3,1fr); gap: .5rem;
  margin-bottom: 1rem;
}
.act-pill {
  background: #f7f5f0; border-radius: 9px;
  padding: .5rem .65rem; display: flex; align-items: center; gap: .45rem;
}
.act-dot  { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.act-name { font-size: .7rem; color: #6b7280; flex: 1; }
.act-n    { font-size: .82rem; font-weight: 700; color: #1a2535; }

/* â”€â”€ Monthly bar chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bar-chart-wrap { display: flex; align-items: flex-end; gap: 5px; height: 56px; }
.bar-col  { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; }
.bar-fill { width: 100%; border-radius: 3px 3px 0 0; background: #1a2535; min-height: 3px; }
.bar-lbl  { font-size: .6rem; color: #9a8f85; }

/* â”€â”€ Edit form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.edit-form .form-group { margin-bottom: .9rem; }
.edit-form label { font-size: .77rem; font-weight: 600; color: #4b5563; display: block; margin-bottom: .2rem; }
.edit-form .form-control {
  border: 1.5px solid #e5e0d8; border-radius: 8px;
  font-size: .85rem; padding: .42rem .75rem;
  color: #1a2535; background: #faf8f4;
  transition: border-color .15s; width: 100%;
}
.edit-form .form-control:focus { border-color: #1a2535; box-shadow: none; outline: none; }
.edit-form .form-control.is-invalid { border-color: #dc2626; }
.invalid-feedback { font-size: .74rem; color: #dc2626; margin-top: 2px; }
.btn-save {
  background: #1a2535; color: #fff; border: none;
  padding: .44rem 1.4rem; border-radius: 8px;
  font-size: .84rem; font-weight: 600; cursor: pointer;
  transition: background .15s;
}
.btn-save:hover { background: #2e3f58; }
.form-control-file { font-size: .8rem; color: #6b7280; }

@media(max-width: 700px) {
  .acct-grid    { grid-template-columns: 1fr; }
  .profile-sidebar { position: static; }
  .streak-pills { grid-template-columns: 1fr 1fr; }
  .act-grid     { grid-template-columns: 1fr 1fr; }
}
</style>

<div class="hm-tip" id="hm-tip"></div>

<div class="acct-grid">

  <!-- â•â• Sidebar â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <aside class="profile-sidebar">
    <div class="avatar-wrap">
      <img class="avatar-img" src="{{ image_file }}" alt="avatar">
      <div class="online-dot"></div>
    </div>
    <div class="profile-name">{{ current_user.username }}</div>
    <div class="profile-email">{{ current_user.email }}</div>

    <div class="pts-box">
      <div class="pts-val">{{ current_user.points }}</div>
      <div class="pts-lbl">âš¡ Total Points</div>
    </div>

    <hr class="sdiv">

    <div class="s-row"><span class="sk">ğŸ”¥ Streak</span>     <span class="sv accent">{{ current_streak }}d</span></div>
    <div class="s-row"><span class="sk">ğŸ† Best</span>        <span class="sv">{{ longest_streak }}d</span></div>
    <div class="s-row"><span class="sk">ğŸ“š Modules</span>    <span class="sv green">{{ modules_done }}</span></div>
    <div class="s-row"><span class="sk">ğŸ”“ Levels</span>     <span class="sv">{{ levels_unlocked }}/3</span></div>
    <div class="s-row"><span class="sk">âœï¸ Posts</span>       <span class="sv">{{ current_user.posts | length }}</span></div>
  </aside>

  <!-- â•â• Main column â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="acct-main">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="alert alert-{{ cat }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- â”€â”€ Streak card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="ac">
      <div class="ac-hd">
        <span class="ac-hd-title">ğŸ”¥ Activity</span>
        <span class="ac-hd-sub">â€” past 52 weeks</span>
      </div>
      <div class="ac-bd">

        <!-- 4 stat pills -->
        <div class="streak-pills">
          <div class="sp">
            <span class="sp-val fire">{{ current_streak }}</span>
            <span class="sp-lbl">Day streak</span>
          </div>
          <div class="sp">
            <span class="sp-val">{{ longest_streak }}</span>
            <span class="sp-lbl">Best streak</span>
          </div>
          <div class="sp">
            <span class="sp-val" id="js-active">0</span>
            <span class="sp-lbl">Active days</span>
          </div>
          <div class="sp">
            <span class="sp-val green" id="js-total">0</span>
            <span class="sp-lbl">Total activities</span>
          </div>
        </div>

        <!-- LeetCode stats bar -->
        <div class="hm-statsbar">
          <div class="hm-total-label">
            <strong id="js-total-label">0</strong> activities in the past one year
          </div>
          <div class="hm-stat">Total active days: <span id="js-active-label">0</span></div>
          <div class="hm-stat">Max streak: <span>{{ longest_streak }}</span></div>
        </div>

        <!-- Heatmap â€” JS builds entire DOM below -->
        <div class="hm-outer" id="hm-outer">
          <!-- day labels + SVG grid injected by JS -->
        </div>
        <!-- Month labels below grid, injected by JS -->
        <div class="hm-month-row" id="hm-months" style="margin-top:5px;"></div>

        <!-- Legend -->
        <div class="hm-legend">
          <span>Less</span>
          <div class="hm-leg" style="background:#ebedf0;"></div>
          <div class="hm-leg" style="background:#9be9a8;"></div>
          <div class="hm-leg" style="background:#40c463;"></div>
          <div class="hm-leg" style="background:#30a14e;"></div>
          <div class="hm-leg" style="background:#216e39;"></div>
          <span>More</span>
        </div>

      </div>
    </div>

    <!-- â”€â”€ Activity breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="ac">
      <div class="ac-hd">
        <span class="ac-hd-title">ğŸ“Š Activity Breakdown</span>
        <span class="ac-hd-sub">â€” past 12 months</span>
      </div>
      <div class="ac-bd">
        <div class="act-grid">
          {% set act_types = [
            ('login',      '#6b7280', 'ğŸ”‘', 'Logins'),
            ('module',     '#2563eb', 'ğŸ§ ', 'Modules'),
            ('quiz',       '#7c3aed', 'ğŸ“', 'Quizzes'),
            ('playground', '#b84c27', 'âš¡', 'Playground'),
            ('post',       '#0891b2', 'âœï¸',  'Posts'),
          ] %}
          {% for key, color, icon, label in act_types %}
          <div class="act-pill">
            <div class="act-dot" style="background:{{ color }};"></div>
            <span class="act-name">{{ icon }} {{ label }}</span>
            <span class="act-n">{{ activity_summary.get(key, 0) }}</span>
          </div>
          {% endfor %}
        </div>

        <div style="font-size:.72rem;color:#9a8f85;margin-bottom:.4rem;">Monthly activity â€” last 6 months</div>
        <div class="bar-chart-wrap" id="monthly-bars"></div>
      </div>
    </div>

    <!-- â”€â”€ Edit profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="ac">
      <div class="ac-hd"><span class="ac-hd-title">âš™ï¸ Edit Profile</span></div>
      <div class="ac-bd">
        <form class="edit-form" method="POST" action="" enctype="multipart/form-data">
          {{ form.hidden_tag() }}

          <div class="form-group">
            {{ form.username.label() }}
            {% if form.username.errors %}
              {{ form.username(class="form-control is-invalid") }}
              <div class="invalid-feedback">{% for e in form.username.errors %}<span>{{ e }}</span>{% endfor %}</div>
            {% else %}
              {{ form.username(class="form-control") }}
            {% endif %}
          </div>

          <div class="form-group">
            {{ form.email.label() }}
            {% if form.email.errors %}
              {{ form.email(class="form-control is-invalid") }}
              <div class="invalid-feedback">{% for e in form.email.errors %}<span>{{ e }}</span>{% endfor %}</div>
            {% else %}
              {{ form.email(class="form-control") }}
            {% endif %}
          </div>

          <div class="form-group">
            {{ form.picture.label() }}
            {{ form.picture(class="form-control-file") }}
            {% if form.picture.errors %}
              {% for e in form.picture.errors %}<span style="font-size:.74rem;color:#dc2626;">{{ e }}</span>{% endfor %}
            {% endif %}
          </div>

          <button type="submit" class="btn-save">Save Changes</button>
        </form>
      </div>
    </div>

  </div><!-- /acct-main -->
</div><!-- /acct-grid -->
<script>
const HM      = {{ heatmap_json | safe }};   // {cells, total, active_days}
const MONTHLY = {{ monthly_json | safe }};

const CELLS       = HM.cells       || [];
const TOTAL       = HM.total       || 0;
const ACTIVE_DAYS = HM.active_days || 0;
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEETCODE-STYLE HEATMAP - COMPLETE REWRITE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Features:
   â€¢ 7 rows (Sun to Sat)
   â€¢ Each month is a separate block with a gap
   â€¢ First cell of month starts on correct weekday row
   â€¢ Month labels positioned under each block
   â€¢ Perfect spacing and alignment
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildLeetCodeHeatmap(cells) {
  const outer = document.getElementById('hm-outer');
  const monthLabelsContainer = document.getElementById('hm-months');
  const tip = document.getElementById('hm-tip');
  
  if (!outer || !monthLabelsContainer) return;
  
  // Clear containers
  outer.innerHTML = '';
  monthLabelsContainer.innerHTML = '';
  
  if (!cells || !cells.length) return;
  
  // â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const CELL_SIZE = 11;           // px
  const CELL_GAP = 3;             // px between cells
  const MONTH_GAP = 16;           // px gap between month blocks (1 column + extra)
  const DAY_LABEL_WIDTH = 24;      // px for day labels column
  const DAY_LABEL_GAP = 5;         // px between day labels and grid
  
  const COLORS = {
    0: '#ebedf0',  // no activity
    1: '#9be9a8',  // low
    2: '#40c463',  // medium-low
    3: '#30a14e',  // medium-high
    4: '#216e39'   // high
  };
  
  const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  
  // â”€â”€ Group cells by month â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const monthGroups = {};
  let minDate = null;
  let maxDate = null;
  
  cells.forEach(cell => {
    const date = new Date(cell.date + 'T12:00:00');
    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
    
    if (!monthGroups[monthKey]) {
      monthGroups[monthKey] = {
        year: date.getFullYear(),
        month: date.getMonth(),
        cells: [],
        firstDay: null,
        daysInMonth: new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate()
      };
    }
    monthGroups[monthKey].cells.push(cell);
    
    if (!minDate || date < minDate) minDate = date;
    if (!maxDate || date > maxDate) maxDate = date;
  });
  
  // Get first day of week for each month
  Object.values(monthGroups).forEach(group => {
    const firstOfMonth = new Date(group.year, group.month, 1);
    group.firstWeekday = firstOfMonth.getDay(); // 0 = Sunday
  });
  
  // Sort months chronologically
  const sortedMonths = Object.values(monthGroups).sort((a, b) => {
    if (a.year !== b.year) return a.year - b.year;
    return a.month - b.month;
  });
  
  // â”€â”€ Create main container with day labels â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const mainContainer = document.createElement('div');
  mainContainer.style.cssText = 'display:flex; align-items:flex-start; min-width:max-content;';
  
  // Day labels column
  const dayLabelCol = document.createElement('div');
  dayLabelCol.style.cssText = `
    display:flex;
    flex-direction:column;
    width:${DAY_LABEL_WIDTH}px;
    flex-shrink:0;
    margin-right:${DAY_LABEL_GAP}px;
    gap:${CELL_GAP}px;
  `;
  
  DAYS.forEach(day => {
    const label = document.createElement('div');
    label.style.cssText = `
      height:${CELL_SIZE}px;
      line-height:${CELL_SIZE}px;
      font-size:0.6rem;
      color:#9a8f85;
      text-align:right;
      white-space:nowrap;
    `;
    label.textContent = day;
    dayLabelCol.appendChild(label);
  });
  mainContainer.appendChild(dayLabelCol);
  
  // â”€â”€ Months container (flex row with gaps) â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const monthsRow = document.createElement('div');
  monthsRow.style.cssText = 'display:flex; gap:16px; align-items:flex-start;';
  
  // Store month label positions for absolute positioning
  const monthPositions = [];
  let cumulativeWidth = 0;
  
  // â”€â”€ Build each month block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sortedMonths.forEach((month, monthIndex) => {
    // Create month block container
    const monthBlock = document.createElement('div');
    monthBlock.style.cssText = `
      display:flex;
      flex-direction:column;
      gap:${CELL_GAP}px;
    `;
    
    // Create a map of dates for quick lookup
    const cellMap = new Map();
    month.cells.forEach(cell => {
      const date = new Date(cell.date + 'T12:00:00');
      cellMap.set(date.getDate(), cell);
    });
    
    // Calculate number of weeks needed for this month
    // First day of month at firstWeekday, month lasts daysInMonth days
    const totalCells = month.firstWeekday + month.daysInMonth;
    const numWeeks = Math.ceil(totalCells / 7);
    
    // Create week rows (each row is a div containing cells for that weekday across weeks)
    // But LeetCode layout: each column is a week, rows are weekdays
    // We need to build columns (weeks) first
    
    // Determine number of columns (weeks) needed
    const numColumns = numWeeks;
    
    // Create columns container for this month
    const columnsContainer = document.createElement('div');
    columnsContainer.style.cssText = `
      display:flex;
      gap:${CELL_GAP}px;
    `;
    
    // For each week column
    for (let week = 0; week < numColumns; week++) {
      const weekColumn = document.createElement('div');
      weekColumn.style.cssText = `
        display:flex;
        flex-direction:column;
        gap:${CELL_GAP}px;
        width:${CELL_SIZE}px;
      `;
      
      // For each day of week (0-6, Sun-Sat)
      for (let weekday = 0; weekday < 7; weekday++) {
        const cellDate = week * 7 + weekday - month.firstWeekday + 1; // Day of month (1-based)
        const cell = document.createElement('div');
        cell.style.cssText = `
          width:${CELL_SIZE}px;
          height:${CELL_SIZE}px;
          border-radius:2px;
          flex-shrink:0;
        `;
        
        // Check if this cell is within the month
        if (cellDate >= 1 && cellDate <= month.daysInMonth) {
          const dayCell = cellMap.get(cellDate);
          
          if (dayCell && dayCell.count > 0) {
            const level = Math.min(dayCell.level || 1, 4);
            cell.style.backgroundColor = COLORS[level] || COLORS[1];
            cell.style.cursor = 'pointer';
            
            if (dayCell.is_today) {
              cell.style.outline = '1.5px solid #b84c27';
              cell.style.outlineOffset = '1px';
            }
            
            // Tooltip
            const dateStr = new Date(dayCell.date + 'T12:00:00')
              .toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
            const tipText = `${dayCell.count} activit${dayCell.count > 1 ? 'ies' : 'y'} Â· ${dateStr}`;
            
            cell.addEventListener('mouseenter', () => {
              tip.textContent = tipText;
              tip.style.display = 'block';
            });
            cell.addEventListener('mousemove', (e) => {
              tip.style.left = (e.clientX + 14) + 'px';
              tip.style.top = (e.clientY - 34) + 'px';
            });
            cell.addEventListener('mouseleave', () => {
              tip.style.display = 'none';
            });
          } else {
            cell.style.backgroundColor = COLORS[0]; // Empty but within month
            cell.style.cursor = 'default';
          }
        } else {
          // Cell outside month range - transparent
          cell.style.backgroundColor = 'transparent';
          cell.style.cursor = 'default';
        }
        
        weekColumn.appendChild(cell);
      }
      columnsContainer.appendChild(weekColumn);
    }
    
    monthBlock.appendChild(columnsContainer);
    
    // Store month position for label
    monthPositions.push({
      label: MONTH_NAMES[month.month],
      width: numColumns * (CELL_SIZE + CELL_GAP) - CELL_GAP, // Total width of month block
      index: monthIndex
    });
    
    monthsRow.appendChild(monthBlock);
  });
  
  mainContainer.appendChild(monthsRow);
  outer.appendChild(mainContainer);
  
  // â”€â”€ Position month labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  monthLabelsContainer.style.cssText = `
    position:relative;
    height:20px;
    margin-top:5px;
    padding-left:${DAY_LABEL_WIDTH + DAY_LABEL_GAP}px;
    min-width:max-content;
  `;
  
  let currentX = 0;
  monthPositions.forEach((pos, idx) => {
    // Calculate center position of month block
    const labelX = currentX + (pos.width / 2) - 12; // Approx half of "Jan" width
    
    const span = document.createElement('span');
    span.style.cssText = `
      position:absolute;
      left:${DAY_LABEL_WIDTH + DAY_LABEL_GAP + labelX}px;
      font-size:0.65rem;
      color:#6b7280;
      white-space:nowrap;
      transform:translateX(-50%);
    `;
    span.textContent = pos.label;
    monthLabelsContainer.appendChild(span);
    
    currentX += pos.width + MONTH_GAP;
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALTERNATIVE APPROACH: DATE-BASED MONTH BLOCKS
   This version uses actual dates to determine month boundaries
   and ensures perfect LeetCode alignment
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildHeatmapFromDates(cells) {
  const outer = document.getElementById('hm-outer');
  const monthLabelsContainer = document.getElementById('hm-months');
  const tip = document.getElementById('hm-tip');
  
  if (!outer || !monthLabelsContainer) return;
  
  outer.innerHTML = '';
  monthLabelsContainer.innerHTML = '';
  
  if (!cells || !cells.length) return;
  
  const CELL_SIZE = 11;
  const CELL_GAP = 3;
  const MONTH_GAP = 16;
  const DAY_LABEL_WIDTH = 24;
  const DAY_LABEL_GAP = 5;
  
  const COLORS = {
    0: '#ebedf0',
    1: '#9be9a8',
    2: '#40c463',
    3: '#30a14e',
    4: '#216e39'
  };
  
  const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  
  // Convert cells to date objects and sort
  const datedCells = cells.map(cell => ({
    ...cell,
    dateObj: new Date(cell.date + 'T12:00:00')
  })).sort((a, b) => a.dateObj - b.dateObj);
  
  if (datedCells.length === 0) return;
  
  // Find date range
  const startDate = new Date(datedCells[0].dateObj);
  const endDate = new Date(datedCells[datedCells.length - 1].dateObj);
  
  // Create a map of all dates we have data for
  const cellMap = new Map();
  datedCells.forEach(cell => {
    const dateKey = cell.dateObj.toISOString().split('T')[0];
    cellMap.set(dateKey, cell);
  });
  
  // Generate all dates in the range
  const allDates = [];
  const currentDate = new Date(startDate);
  currentDate.setDate(1); // Start from first day of start month
  
  // Go to first day of start month
  currentDate.setDate(1);
  
  // Generate up to end date + 1 month
  const endDatePlus = new Date(endDate);
  endDatePlus.setMonth(endDatePlus.getMonth() + 1);
  
  while (currentDate <= endDatePlus) {
    allDates.push(new Date(currentDate));
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  // Group by month
  const monthBlocks = [];
  let currentMonth = -1;
  let currentMonthDates = [];
  
  allDates.forEach(date => {
    const monthKey = date.getMonth();
    const yearKey = date.getFullYear();
    const monthYear = `${yearKey}-${monthKey}`;
    
    if (monthKey !== currentMonth) {
      if (currentMonthDates.length > 0) {
        monthBlocks.push({
          year: currentMonthDates[0].getFullYear(),
          month: currentMonth,
          dates: [...currentMonthDates]
        });
      }
      currentMonth = monthKey;
      currentMonthDates = [date];
    } else {
      currentMonthDates.push(date);
    }
  });
  
  // Add last month
  if (currentMonthDates.length > 0) {
    monthBlocks.push({
      year: currentMonthDates[0].getFullYear(),
      month: currentMonth,
      dates: [...currentMonthDates]
    });
  }
  
  // Build main container
  const mainContainer = document.createElement('div');
  mainContainer.style.cssText = 'display:flex; align-items:flex-start; min-width:max-content;';
  
  // Day labels
  const dayLabelCol = document.createElement('div');
  dayLabelCol.style.cssText = `
    display:flex;
    flex-direction:column;
    width:${DAY_LABEL_WIDTH}px;
    flex-shrink:0;
    margin-right:${DAY_LABEL_GAP}px;
    gap:${CELL_GAP}px;
  `;
  
  DAYS.forEach(day => {
    const label = document.createElement('div');
    label.style.cssText = `
      height:${CELL_SIZE}px;
      line-height:${CELL_SIZE}px;
      font-size:0.6rem;
      color:#9a8f85;
      text-align:right;
      white-space:nowrap;
    `;
    label.textContent = day;
    dayLabelCol.appendChild(label);
  });
  mainContainer.appendChild(dayLabelCol);
  
  // Months row
  const monthsRow = document.createElement('div');
  monthsRow.style.cssText = 'display:flex; gap:16px; align-items:flex-start;';
  
  const monthPositions = [];
  let cumulativeWidth = 0;
  
  // Build each month
  monthBlocks.forEach((month, idx) => {
    const firstDate = month.dates[0];
    const firstWeekday = firstDate.getDay();
    
    // Create grid for this month
    const monthDiv = document.createElement('div');
    monthDiv.style.cssText = 'display:flex; flex-direction:column;';
    
    // Calculate weeks needed
    const numWeeks = Math.ceil((firstWeekday + month.dates.length) / 7);
    
    // Create columns (weeks)
    const weeksDiv = document.createElement('div');
    weeksDiv.style.cssText = `display:flex; gap:${CELL_GAP}px;`;
    
    for (let week = 0; week < numWeeks; week++) {
      const weekDiv = document.createElement('div');
      weekDiv.style.cssText = `
        display:flex;
        flex-direction:column;
        gap:${CELL_GAP}px;
        width:${CELL_SIZE}px;
      `;
      
      for (let weekday = 0; weekday < 7; weekday++) {
        const dayIndex = week * 7 + weekday - firstWeekday;
        const cellDiv = document.createElement('div');
        cellDiv.style.cssText = `
          width:${CELL_SIZE}px;
          height:${CELL_SIZE}px;
          border-radius:2px;
          flex-shrink:0;
        `;
        
        if (dayIndex >= 0 && dayIndex < month.dates.length) {
          const currentDate = month.dates[dayIndex];
          const dateKey = currentDate.toISOString().split('T')[0];
          const cell = cellMap.get(dateKey);
          
          if (cell && cell.count > 0) {
            const level = Math.min(cell.level || 1, 4);
            cellDiv.style.backgroundColor = COLORS[level];
            cellDiv.style.cursor = 'pointer';
            
            if (cell.is_today) {
              cellDiv.style.outline = '1.5px solid #b84c27';
              cellDiv.style.outlineOffset = '1px';
            }
            
            // Tooltip
            const dateStr = currentDate.toLocaleDateString('en-US', 
              { month:'short', day:'numeric', year:'numeric' });
            const tipText = `${cell.count} activit${cell.count > 1 ? 'ies' : 'y'} Â· ${dateStr}`;
            
            cellDiv.addEventListener('mouseenter', () => {
              tip.textContent = tipText;
              tip.style.display = 'block';
            });
            cellDiv.addEventListener('mousemove', (e) => {
              tip.style.left = (e.clientX + 14) + 'px';
              tip.style.top = (e.clientY - 34) + 'px';
            });
            cellDiv.addEventListener('mouseleave', () => {
              tip.style.display = 'none';
            });
          } else {
            cellDiv.style.backgroundColor = COLORS[0];
          }
        } else {
          cellDiv.style.backgroundColor = 'transparent';
        }
        
        weekDiv.appendChild(cellDiv);
      }
      weeksDiv.appendChild(weekDiv);
    }
    
    monthDiv.appendChild(weeksDiv);
    monthsRow.appendChild(monthDiv);
    
    // Calculate width for month label
    const monthWidth = numWeeks * (CELL_SIZE + CELL_GAP) - CELL_GAP;
    monthPositions.push({
      label: MONTH_NAMES[month.month],
      width: monthWidth,
      index: idx
    });
  });
  
  mainContainer.appendChild(monthsRow);
  outer.appendChild(mainContainer);
  
  // Position month labels
  monthLabelsContainer.style.cssText = `
    position:relative;
    height:20px;
    margin-top:5px;
    padding-left:${DAY_LABEL_WIDTH + DAY_LABEL_GAP}px;
    min-width:max-content;
  `;
  
  let currentX = 0;
  monthPositions.forEach((pos, idx) => {
    const labelX = currentX + (pos.width / 2);
    
    const span = document.createElement('span');
    span.style.cssText = `
      position:absolute;
      left:${DAY_LABEL_WIDTH + DAY_LABEL_GAP + labelX}px;
      font-size:0.65rem;
      color:#6b7280;
      white-space:nowrap;
      transform:translateX(-50%);
    `;
    span.textContent = pos.label;
    monthLabelsContainer.appendChild(span);
    
    currentX += pos.width + MONTH_GAP;
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INITIALIZATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
buildHeatmapFromDates(CELLS);

// Live refresh function
async function refreshHeatmap() {
  try {
    const resp = await fetch('/account/heatmap_data', {
      headers: { 'Cache-Control': 'no-cache' }
    });
    if (!resp.ok) return;
    const data = await resp.json();
    
    const hm = data.heatmap;
    
    // Update stat numbers
    document.getElementById('js-total').textContent = hm.total;
    document.getElementById('js-active').textContent = hm.active_days;
    document.getElementById('js-total-label').textContent = hm.total;
    document.getElementById('js-active-label').textContent = hm.active_days;
    
    // Update points in sidebar
    const ptsEl = document.querySelector('.pts-val');
    if (ptsEl) ptsEl.textContent = data.points;
    
    // Rebuild heatmap
    buildHeatmapFromDates(hm.cells || []);
    
  } catch(e) {
    console.warn('Heatmap refresh failed:', e);
  }
}

// Visibility change and polling
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    refreshHeatmap();
  }
});

// Poll every 30 seconds
setInterval(refreshHeatmap, 30000);
</script>
{% endblock content %}
