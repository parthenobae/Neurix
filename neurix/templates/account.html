{% extends "layout.html" %}

{# Full-width â€” no sidebar #}
{% block content_col_class %}col-12{% endblock %}
{% block sidebar %}{% endblock %}

{% block content %}
<style>
/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; }

.acct-grid {
  display: grid;
  grid-template-columns: 200px 1fr;
  gap: 1.2rem;
  align-items: start;
  max-width: 960px;
  margin: 0 auto;
}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-sidebar {
  background: #fff;
  border: 1.5px solid #e5e0d8;
  border-radius: 14px;
  padding: 1.4rem 1.1rem;
  text-align: center;
  box-shadow: 0 2px 8px rgba(26,37,53,.06);
  position: sticky;
  top: 80px;
}
.avatar-wrap { position: relative; display: inline-block; margin-bottom: .8rem; }
.avatar-img  { width: 84px; height: 84px; border-radius: 50%; border: 3px solid #e5e0d8; object-fit: cover; }
.online-dot  { position: absolute; bottom: 3px; right: 3px; width: 16px; height: 16px; background: #27a35a; border-radius: 50%; border: 2.5px solid #fff; }

.profile-name  { font-family: 'DM Serif Display', serif; font-size: 1.08rem; color: #1a2535; margin-bottom: .1rem; }
.profile-email { font-size: .72rem; color: #9a8f85; margin-bottom: .9rem; }

.pts-box  { background: #1a2535; border-radius: 10px; padding: .5rem .8rem; margin-bottom: .9rem; }
.pts-val  { font-family: 'DM Serif Display', serif; font-size: 1.65rem; color: #f59e0b; line-height: 1; }
.pts-lbl  { font-size: .65rem; color: #64748b; margin-top: 2px; }

.sdiv { border: none; border-top: 1px solid #f0ede8; margin: .8rem 0; }

.s-row { display: flex; justify-content: space-between; align-items: center; padding: .2rem 0; font-size: .76rem; }
.s-row .sk { color: #6b7280; }
.s-row .sv { font-weight: 700; color: #1a2535; }
.s-row .sv.accent { color: #b84c27; }
.s-row .sv.green  { color: #27a35a; }

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.acct-main { display: flex; flex-direction: column; gap: 1.1rem; }

.ac {
  background: #fff;
  border: 1.5px solid #e5e0d8;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(26,37,53,.05);
}
.ac-hd {
  display: flex; align-items: baseline; gap: .5rem;
  padding: .75rem 1.2rem;
  border-bottom: 1px solid #f0ede8;
}
.ac-hd-title { font-family: 'DM Serif Display', serif; font-size: .97rem; color: #1a2535; }
.ac-hd-sub   { font-size: .71rem; color: #9a8f85; }
.ac-bd { padding: 1rem 1.2rem; }

/* â”€â”€ Streak pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.streak-pills {
  display: grid; grid-template-columns: repeat(4,1fr); gap: .55rem;
  margin-bottom: 1.1rem;
}
.sp { background: #f7f5f0; border-radius: 10px; padding: .6rem .4rem; text-align: center; }
.sp-val { font-family: 'DM Serif Display', serif; font-size: 1.45rem; color: #1a2535; line-height: 1; display: block; }
.sp-val.fire  { color: #b84c27; }
.sp-val.green { color: #27a35a; }
.sp-lbl { font-size: .62rem; color: #9a8f85; margin-top: 3px; display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GITHUB-STYLE HEATMAP (past 12 rolling months)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Stats bar above grid */
.hm-statsbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 1rem;
  font-size: 0.85rem;
}
.hm-total-label {
  color: #1a2535;
  font-weight: 500;
}
.hm-total-label strong {
  font-weight: 700;
  color: #1a2535;
}
.hm-stats-right {
  display: flex;
  gap: 1.5rem;
  color: #6b7280;
}
.hm-stat span {
  font-weight: 600;
  color: #1a2535;
  margin-left: 0.25rem;
}

/* Heatmap container */
.heatmap-container {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  overflow-x: auto;
  padding-bottom: 0.5rem;
}

/* Main heatmap wrapper */
.heatmap-wrapper {
  display: flex;
  gap: 0.5rem;
  min-width: max-content;
}

/* Day labels column */

/* Months container - flex row with gaps */
.months-container {
  display: flex;
  gap: 16px;
  align-items: flex-start;
}

/* Individual month block */
.month-block {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

/* Week row within a month */
.week-row {
  display: flex;
  gap: 3px;
}

/* Individual day cell */
.day-cell {
  width: 11px;
  height: 11px;
  border-radius: 2px;
  background-color: #ebedf0;
  cursor: pointer;
  transition: transform 0.1s ease;
}
.day-cell:hover {
  transform: scale(1.15);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

/* Month labels row */
.month-labels-row {
  position: relative;
  height: 20px;
  margin-top: 4px;
  padding-left: 26px; /* Match day labels width */
  min-width: max-content;
}
.month-label {
  position: absolute;
  font-size: 0.65rem;
  color: #6b7280;
  white-space: nowrap;
  transform: translateX(-50%);
}

/* Legend */
.hm-legend {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 8px;
  justify-content: flex-end;
  font-size: .64rem;
  color: #9a8f85;
}
.hm-leg {
  width: 11px;
  height: 11px;
  border-radius: 2px;
}

/* Tooltip */
.hm-tip {
  position: fixed;
  background: #1a2535;
  color: #e2e8f0;
  font-size: .71rem;
  padding: .3rem .6rem;
  border-radius: 6px;
  pointer-events: none;
  display: none;
  z-index: 9999;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0,0,0,.3);
}

/* â”€â”€ Activity breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.act-grid {
  display: grid; grid-template-columns: repeat(3,1fr); gap: .5rem;
  margin-bottom: 1rem;
}
.act-pill {
  background: #f7f5f0; border-radius: 9px;
  padding: .5rem .65rem; display: flex; align-items: center; gap: .45rem;
}
.act-dot  { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.act-name { font-size: .7rem; color: #6b7280; flex: 1; }
.act-n    { font-size: .82rem; font-weight: 700; color: #1a2535; }

/* â”€â”€ Monthly bar chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bar-chart-wrap { display: flex; align-items: flex-end; gap: 5px; height: 56px; }
.bar-col  { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; }
.bar-fill { width: 100%; border-radius: 3px 3px 0 0; background: #1a2535; min-height: 3px; }
.bar-lbl  { font-size: .6rem; color: #9a8f85; }

/* â”€â”€ Edit form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.edit-form .form-group { margin-bottom: .9rem; }
.edit-form label { font-size: .77rem; font-weight: 600; color: #4b5563; display: block; margin-bottom: .2rem; }
.edit-form .form-control {
  border: 1.5px solid #e5e0d8; border-radius: 8px;
  font-size: .85rem; padding: .42rem .75rem;
  color: #1a2535; background: #faf8f4;
  transition: border-color .15s; width: 100%;
}
.edit-form .form-control:focus { border-color: #1a2535; box-shadow: none; outline: none; }
.edit-form .form-control.is-invalid { border-color: #dc2626; }
.invalid-feedback { font-size: .74rem; color: #dc2626; margin-top: 2px; }
.btn-save {
  background: #1a2535; color: #fff; border: none;
  padding: .44rem 1.4rem; border-radius: 8px;
  font-size: .84rem; font-weight: 600; cursor: pointer;
  transition: background .15s;
}
.btn-save:hover { background: #2e3f58; }
.form-control-file { font-size: .8rem; color: #6b7280; }

@media(max-width: 700px) {
  .acct-grid    { grid-template-columns: 1fr; }
  .profile-sidebar { position: static; }
  .streak-pills { grid-template-columns: 1fr 1fr; }
  .act-grid     { grid-template-columns: 1fr 1fr; }
  .hm-statsbar { flex-direction: column; align-items: flex-start; }
  .hm-stats-right { flex-wrap: wrap; gap: 1rem; }
}
</style>

<div class="hm-tip" id="hm-tip"></div>

<div class="acct-grid">

  <!-- â•â• Sidebar â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <aside class="profile-sidebar">
    <div class="avatar-wrap">
      <img class="avatar-img" src="{{ image_file }}" alt="avatar">
      <div class="online-dot"></div>
    </div>
    <div class="profile-name">{{ current_user.username }}</div>
    <div class="profile-email">{{ current_user.email }}</div>

    <div class="pts-box">
      <div class="pts-val">{{ current_user.points }}</div>
      <div class="pts-lbl">âš¡ Total Points</div>
    </div>

    <hr class="sdiv">

    <div class="s-row"><span class="sk">ğŸ”¥ Streak</span>     <span class="sv accent">{{ current_streak }}d</span></div>
    <div class="s-row"><span class="sk">ğŸ† Best</span>        <span class="sv">{{ longest_streak }}d</span></div>
    <div class="s-row"><span class="sk">ğŸ“š Modules</span>    <span class="sv green">{{ modules_done }}</span></div>
    <div class="s-row"><span class="sk">ğŸ”“ Levels</span>     <span class="sv">{{ levels_unlocked }}/3</span></div>
    <div class="s-row"><span class="sk">âœï¸ Posts</span>       <span class="sv">{{ current_user.posts | length }}</span></div>
  </aside>

  <!-- â•â• Main column â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="acct-main">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="alert alert-{{ cat }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- â”€â”€ Activity card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="ac">
      <div class="ac-hd">
        <span class="ac-hd-title">ğŸ”¥ Contribution Activity</span>
        <span class="ac-hd-sub">â€” past 12 rolling months</span>
      </div>
      <div class="ac-bd">

        <!-- 4 stat pills -->
        <div class="streak-pills">
          <div class="sp">
            <span class="sp-val fire">{{ current_streak }}</span>
            <span class="sp-lbl">Day streak</span>
          </div>
          <div class="sp">
            <span class="sp-val">{{ longest_streak }}</span>
            <span class="sp-lbl">Best streak</span>
          </div>
          <div class="sp">
            <span class="sp-val" id="js-active">0</span>
            <span class="sp-lbl">Active days</span>
          </div>
          <div class="sp">
            <span class="sp-val green" id="js-total">0</span>
            <span class="sp-lbl">Total activities</span>
          </div>
        </div>

        <!-- Stats bar -->
        <div class="hm-statsbar">
          <div class="hm-total-label">
            <strong id="js-total-label">0</strong> submissions in the past one year
          </div>
          <div class="hm-stats-right">
            <div class="hm-stat">Total active days: <span id="js-active-label">0</span></div>
            <div class="hm-stat">Max streak: <span>{{ longest_streak }}</span></div>
          </div>
        </div>

        <!-- Heatmap container -->
        <div class="heatmap-container" id="heatmap-container">
          <!-- JS will inject the heatmap here -->
        </div>

        <!-- Month labels row (separate container for positioning) -->
        <div class="month-labels-row" id="month-labels-row"></div>

        <!-- Legend -->
        <div class="hm-legend">
          <span>Less</span>
          <div class="hm-leg" style="background:#ebedf0;"></div>
          <div class="hm-leg" style="background:#9be9a8;"></div>
          <div class="hm-leg" style="background:#40c463;"></div>
          <div class="hm-leg" style="background:#30a14e;"></div>
          <div class="hm-leg" style="background:#216e39;"></div>
          <span>More</span>
        </div>

      </div>
    </div>

    <!-- â”€â”€ Activity breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="ac">
      <div class="ac-hd">
        <span class="ac-hd-title">ğŸ“Š Activity Breakdown</span>
        <span class="ac-hd-sub">â€” past 12 months</span>
      </div>
      <div class="ac-bd">
        <div class="act-grid">
          {% set act_types = [
            ('login',      '#6b7280', 'ğŸ”‘', 'Logins'),
            ('module',     '#2563eb', 'ğŸ§ ', 'Modules'),
            ('quiz',       '#7c3aed', 'ğŸ“', 'Quizzes'),
            ('playground', '#b84c27', 'âš¡', 'Playground'),
            ('post',       '#0891b2', 'âœï¸',  'Posts'),
          ] %}
          {% for key, color, icon, label in act_types %}
          <div class="act-pill">
            <div class="act-dot" style="background:{{ color }};"></div>
            <span class="act-name">{{ icon }} {{ label }}</span>
            <span class="act-n">{{ activity_summary.get(key, 0) }}</span>
          </div>
          {% endfor %}
        </div>

        <div style="font-size:.72rem;color:#9a8f85;margin-bottom:.4rem;">Monthly activity â€” last 6 months</div>
        <div class="bar-chart-wrap" id="monthly-bars"></div>
      </div>
    </div>

    <!-- â”€â”€ Edit profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="ac">
      <div class="ac-hd"><span class="ac-hd-title">âš™ï¸ Edit Profile</span></div>
      <div class="ac-bd">
        <form class="edit-form" method="POST" action="" enctype="multipart/form-data">
          {{ form.hidden_tag() }}

          <div class="form-group">
            {{ form.username.label() }}
            {% if form.username.errors %}
              {{ form.username(class="form-control is-invalid") }}
              <div class="invalid-feedback">{% for e in form.username.errors %}<span>{{ e }}</span>{% endfor %}</div>
            {% else %}
              {{ form.username(class="form-control") }}
            {% endif %}
          </div>

          <div class="form-group">
            {{ form.email.label() }}
            {% if form.email.errors %}
              {{ form.email(class="form-control is-invalid") }}
              <div class="invalid-feedback">{% for e in form.email.errors %}<span>{{ e }}</span>{% endfor %}</div>
            {% else %}
              {{ form.email(class="form-control") }}
            {% endif %}
          </div>

          <div class="form-group">
            {{ form.picture.label() }}
            {{ form.picture(class="form-control-file") }}
            {% if form.picture.errors %}
              {% for e in form.picture.errors %}<span style="font-size:.74rem;color:#dc2626;">{{ e }}</span>{% endfor %}
            {% endif %}
          </div>

          <button type="submit" class="btn-save">Save Changes</button>
        </form>
      </div>
    </div>

  </div><!-- /acct-main -->
</div><!-- /acct-grid -->

<script>
// ===================================================
// GITHUB-STYLE HEATMAP - PAST 12 ROLLING MONTHS
// CORRECTED VERTICAL LAYOUT (SUNDAY ON TOP)
// ===================================================

// Data from Flask
const HM = {{ heatmap_json | safe }};
const MONTHLY = {{ monthly_json | safe }};

// Extract data
const CELLS = HM.cells || [];
const TOTAL = HM.total || 0;
const ACTIVE_DAYS = HM.active_days || 0;

// Update stat displays
document.getElementById('js-total').textContent = TOTAL;
document.getElementById('js-active').textContent = ACTIVE_DAYS;
document.getElementById('js-total-label').textContent = TOTAL;
document.getElementById('js-active-label').textContent = ACTIVE_DAYS;

// ===================================================
// Configuration
// ===================================================
const CONFIG = {
  cellSize: 11,
  cellGap: 3,
  monthGap: 16,
  dayLabelWidth: 0,  // no day labels
  
  colors: {
    0: '#ebedf0',
    1: '#9be9a8',
    2: '#40c463',
    3: '#30a14e',
    4: '#216e39'
  },
  
  monthNames: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
  
  weekdays: [] // removed â€” no day labels shown
};

// ===================================================
// Core Heatmap Builder - CORRECTED VERSION
// ===================================================
function buildHeatmap() {
  const container = document.getElementById('heatmap-container');
  const monthLabelsRow = document.getElementById('month-labels-row');
  const tip = document.getElementById('hm-tip');
  
  if (!container || !monthLabelsRow) return;
  
  container.innerHTML = '';
  monthLabelsRow.innerHTML = '';
  
  if (!CELLS.length) {
    container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #9a8f85;">No activity data available for the past year</div>';
    return;
  }

  // Create activity map
  const activityMap = new Map();
  CELLS.forEach(cell => {
    activityMap.set(cell.date, cell);
  });

  // Generate date range (past 12 rolling months)
  const today = new Date();
  today.setHours(12, 0, 0, 0);
  
  const startDate = new Date(today);
  startDate.setMonth(today.getMonth() - 11);
  startDate.setDate(1);
  
  const endDate = new Date(today);
  
  // Generate all dates
  const allDates = [];
  const currentDate = new Date(startDate);
  while (currentDate <= endDate) {
    allDates.push(new Date(currentDate));
    currentDate.setDate(currentDate.getDate() + 1);
  }

  // Group by month
  const months = [];
  let currentMonthGroup = [];
  let currentMonthKey = '';
  
  allDates.forEach(date => {
    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
    
    if (monthKey !== currentMonthKey) {
      if (currentMonthGroup.length > 0) {
        months.push({
          year: currentMonthGroup[0].getFullYear(),
          month: currentMonthGroup[0].getMonth(),
          dates: [...currentMonthGroup]
        });
      }
      currentMonthGroup = [date];
      currentMonthKey = monthKey;
    } else {
      currentMonthGroup.push(date);
    }
  });
  
  if (currentMonthGroup.length > 0) {
    months.push({
      year: currentMonthGroup[0].getFullYear(),
      month: currentMonthGroup[0].getMonth(),
      dates: [...currentMonthGroup]
    });
  }

  // Main wrapper
  const wrapper = document.createElement('div');
  wrapper.style.display = 'flex';
  wrapper.style.alignItems = 'flex-start';
  wrapper.style.minWidth = 'max-content';
  wrapper.style.gap = '0px';

  // Day labels removed

  // Months container
  const monthsContainer = document.createElement('div');
  monthsContainer.style.display = 'flex';
  monthsContainer.style.gap = CONFIG.monthGap + 'px';
  monthsContainer.style.alignItems = 'flex-start';

  const monthPositions = [];
  let cumulativeWidth = 0;

  // Build each month
  months.forEach((month) => {
    const firstDate = month.dates[0];
    const firstWeekday = firstDate.getDay(); // 0 = Sunday
    
    // Calculate number of weeks needed
    const totalSlots = firstWeekday + month.dates.length;
    const numWeeks = Math.ceil(totalSlots / 7);
    
    // Create month block
    const monthBlock = document.createElement('div');
    monthBlock.style.display = 'flex';
    monthBlock.style.flexDirection = 'row'; // Weeks are columns (side by side)
    monthBlock.style.gap = CONFIG.cellGap + 'px';
    
    // Create columns for each week
    for (let week = 0; week < numWeeks; week++) {
      const weekColumn = document.createElement('div');
      weekColumn.style.display = 'flex';
      weekColumn.style.flexDirection = 'column'; // Days stack vertically
      weekColumn.style.gap = CONFIG.cellGap + 'px';
      weekColumn.style.width = CONFIG.cellSize + 'px';
      
      // Create cells for each day of the week
      for (let weekday = 0; weekday < 7; weekday++) {
        const dayIndex = week * 7 + weekday - firstWeekday;
        const cell = document.createElement('div');
        
        cell.style.width = CONFIG.cellSize + 'px';
        cell.style.height = CONFIG.cellSize + 'px';
        cell.style.borderRadius = '2px';
        cell.style.flexShrink = '0';
        
        if (dayIndex >= 0 && dayIndex < month.dates.length) {
          const currentDate = month.dates[dayIndex];
          const dateStr = currentDate.toISOString().split('T')[0];
          const activity = activityMap.get(dateStr);
          
          if (activity && activity.count > 0) {
            const level = Math.min(activity.level || 1, 4);
            cell.style.backgroundColor = CONFIG.colors[level];
            cell.style.cursor = 'pointer';
            
            // Tooltip
            const displayDate = currentDate.toLocaleDateString('en-US', {
              month: 'short', day: 'numeric', year: 'numeric'
            });
            const tipText = `${activity.count} submission${activity.count > 1 ? 's' : ''} Â· ${displayDate}`;
            
            cell.addEventListener('mouseenter', () => {
              tip.textContent = tipText;
              tip.style.display = 'block';
            });
            cell.addEventListener('mousemove', (e) => {
              tip.style.left = (e.clientX + 14) + 'px';
              tip.style.top = (e.clientY - 34) + 'px';
            });
            cell.addEventListener('mouseleave', () => {
              tip.style.display = 'none';
            });
            
            // Highlight today
            const todayStr = new Date().toISOString().split('T')[0];
            if (dateStr === todayStr) {
              cell.style.outline = '1.5px solid #b84c27';
              cell.style.outlineOffset = '1px';
            }
          } else {
            cell.style.backgroundColor = CONFIG.colors[0];
          }
        } else {
          cell.style.backgroundColor = 'transparent';
        }
        
        weekColumn.appendChild(cell);
      }
      monthBlock.appendChild(weekColumn);
    }
    
    monthsContainer.appendChild(monthBlock);
    
    // Calculate width for month label
    const monthWidth = numWeeks * (CONFIG.cellSize + CONFIG.cellGap) - CONFIG.cellGap;
    monthPositions.push({
      label: CONFIG.monthNames[month.month],
      width: monthWidth
    });
  });

  wrapper.appendChild(monthsContainer);
  container.appendChild(wrapper);

  // Position month labels
  monthLabelsRow.style.paddingLeft = CONFIG.dayLabelWidth + 'px';
  monthLabelsRow.style.position = 'relative';
  monthLabelsRow.style.height = '20px';
  monthLabelsRow.style.marginTop = '5px';
  
  let currentX = 0;
  monthPositions.forEach(pos => {
    const labelX = currentX + (pos.width / 2);
    
    const label = document.createElement('span');
    label.style.position = 'absolute';
    label.style.left = labelX + 'px';
    label.style.fontSize = '0.65rem';
    label.style.color = '#6b7280';
    label.style.whiteSpace = 'nowrap';
    label.style.transform = 'translateX(-50%)';
    label.textContent = pos.label;
    
    monthLabelsRow.appendChild(label);
    
    currentX += pos.width + CONFIG.monthGap;
  });
}

// ===================================================
// Monthly Bar Chart
// ===================================================
function buildMonthlyBars() {
  const wrap = document.getElementById('monthly-bars');
  if (!wrap || !MONTHLY || !MONTHLY.length) return;
  
  wrap.innerHTML = '';
  
  const last6 = MONTHLY.slice(-6);
  const max = Math.max(...last6.map(m => m.total), 1);
  
  last6.forEach(m => {
    const pct = m.total > 0 ? (m.total / max) * 100 : 2;
    
    const col = document.createElement('div');
    col.style.flex = '1';
    col.style.display = 'flex';
    col.style.flexDirection = 'column';
    col.style.alignItems = 'center';
    col.style.gap = '3px';
    
    const fill = document.createElement('div');
    fill.style.width = '100%';
    fill.style.borderRadius = '3px 3px 0 0';
    fill.style.background = m.total > 0 ? '#40c463' : '#ebedf0';
    fill.style.minHeight = '3px';
    fill.style.height = Math.max(pct, 4) + '%';
    fill.title = `${m.total} activities in ${m.month}`;
    
    const label = document.createElement('div');
    label.style.fontSize = '0.6rem';
    label.style.color = '#9a8f85';
    label.textContent = m.month;
    
    col.appendChild(fill);
    col.appendChild(label);
    wrap.appendChild(col);
  });
}

// ===================================================
// Live Refresh
// ===================================================
async function refreshHeatmap() {
  try {
    const resp = await fetch('/account/heatmap_data', {
      headers: { 'Cache-Control': 'no-cache' }
    });
    if (!resp.ok) return;
    
    const data = await resp.json();
    const hm = data.heatmap;
    
    document.getElementById('js-total').textContent = hm.total;
    document.getElementById('js-active').textContent = hm.active_days;
    document.getElementById('js-total-label').textContent = hm.total;
    document.getElementById('js-active-label').textContent = hm.active_days;
    
    const ptsEl = document.querySelector('.pts-val');
    if (ptsEl) ptsEl.textContent = data.points;
    
    // Update CELLS
    CELLS.length = 0;
    CELLS.push(...(hm.cells || []));
    
    buildHeatmap();
    buildMonthlyBars();
    
  } catch(e) {
    console.warn('Refresh failed:', e);
  }
}

// ===================================================
// Initialize
// ===================================================
// Small delay to ensure DOM is ready
setTimeout(() => {
  buildHeatmap();
  buildMonthlyBars();
}, 100);

// Visibility change
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    refreshHeatmap();
  }
});

// Poll every 30 seconds
setInterval(refreshHeatmap, 30000);
</script>
{% endblock content %}
